(function closure(context){function Timer(){const me=this;var baseTime;var startTime;var multiplier;var interval=null;var markers=[];var prevTime=0;var _withEvents;var _reset={};var _times={};function construct(time,interval,state,bottom,top,loop,speed,withEvents){if(typeof(time)=="boolean"){withEvents=time;time=Timer.DEFAULT_TIME}else{if(typeof(interval)=="boolean"){withEvents=interval;interval=Timer.DEFAULT_INTERVAL}else{if(typeof(state)=="boolean"){withEvents=state;state=Timer.DEFAULT_PLAYSTATE}else{if(typeof(bottom)=="boolean"){withEvents=bottom;bottom=Timer.DEFAULT_BOTTOM}else{if(typeof(speed)=="boolean"){withEvents=speed;speed=Timer.DEFAULT_SPEED}}}}}if((time<me.bottom)||(time>me.top)){throw new TypeError("time lies outside of the available range of the timer")}me.bottom=(typeof(bottom)==="number")?bottom:Timer.DEFAULT_BOTTOM;_reset.bottom=me.bottom;me.loop=(typeof(loop)==="boolean")?loop:Timer.DEFAULT_LOOP;_reset.loop=me.loop;me.speed=(typeof(speed)==="number")?speed:Timer.DEFAULT_SPEED;_reset.speed=me.speed;me.interval=(typeof(interval)==="number")?interval:Timer.DEFAULT_INTERVAL;_reset.interval=me.interval;me.time=(typeof(time)==="number")?time:Timer.DEFAULT_TIME;_reset.time=me.time;me.top=(typeof(top)==="number")?top:Timer.DEFAULT_TOP;_reset.top=me.top;_state=(typeof(state)==="number")?state:Timer.DEFAULT_PLAYSTATE;_reset.state=_state;_withEvents=(typeof(withEvents)==="boolean")?withEvents:Timer.DEFAULT_RAISES_EVENTS;if(me.state==Timer.PLAYING){play()}}Object.defineProperty(me,"bottom",{get:function(){return _bottom},set:function(value){_bottom=(typeof value==="number")?Math.toZero(value):Timer.DEFAULT_BOTTOM},enumerable:true});var _bottom=Timer.DEFAULT_BOTTOM;Object.defineProperty(me,"loop",{get:function(){return _loop},set:function(value){_loop=value?true:false},enumerable:true});var _loop=null;Object.defineProperty(me,"speed",{get:function(){return _speed},set:function(value){baseTime=Math.toZero(me.time);startTime=Date.now();_speed=value?value:Timer.DEFAULT_SPEED},enumerable:true});var _speed=Timer.DEFAULT_SPEED;Object.defineProperty(me,"state",{get:function(){return _state},enumerable:true});var _state=0;Object.defineProperty(me,"top",{get:function(){return _top},set:function(value){_top=value?Math.toZero(value):Timer.DEFAULT_TOP},enumerable:true});var _top=Timer.DEFAULT_TOP;Object.defineProperty(me,"interval",{get:function(){return _interval},set:function(value){_interval=value?Math.max(1,value):Timer.DEFAULT_INTERVAL},enumerable:true});var _interval=Timer.DEFAULT_INTERVAL;Object.defineProperty(me,"ticks",{get:function(){return Math.toZero(me.time/_interval)},enumerable:true});Object.defineProperty(me,"time",{get:function(){var returnTime=Math.toZero(baseTime+((Date.now()-startTime)*(_speed*Math.min(_state,1))));returnTime=Math.max(_bottom,Math.min(_top,returnTime));return !isNaN(returnTime)?returnTime:_reset.time},set:function(time){if((time<_bottom)||(time>_top)){throw new TypeError("time lies outside of the available range of the timer")}baseTime=Math.toZero(time);startTime=Date.now();update()},enumerable:true});function play(){baseTime=me.time;startTime=Date.now();_state=Timer.PLAYING;_speed=_reset.speed;setTimerInterval();dispatchEvent(new TimerEvent("play",{time:baseTime}))}play.parent=me;me.play=play;function pause(){baseTime=me.time;startTime=Date.now();_state=Timer.STOPPED;clearTimerInterval();update();dispatchEvent(new TimerEvent("stop",{time:baseTime}))}pause.parent=me;me.pause=pause;function stop(){baseTime=_reset.time;startTime=Date.now();_state=Timer.STOPPED;clearTimerInterval();update();dispatchEvent(new TimerEvent("stop",{time:baseTime}));dispatchEvent(new TimerEvent("reset",{time:baseTime}))}stop.parent=me;me.stop=stop;function reset(){baseTime=_reset.time;startTime=Date.now();update();dispatchEvent(new TimerEvent("reset",{time:baseTime}))}reset.parent=me;me.reset=reset;function fastForward(){baseTime=me.time;startTime=Date.now();_state=Timer.PLAYING;_speed=_reset.speed*2;setTimerInterval();dispatchEvent(new TimerEvent("play",{time:baseTime}))}fastForward.parent=me;me.fastForward=fastForward;function playBackward(){baseTime=me.time;startTime=Date.now();_state=Timer.PLAYING;_speed=_reset.speed*-1;setTimerInterval();dispatchEvent(new TimerEvent("play",{time:baseTime}))}playBackward.parent=me;me.playBackward=playBackward;function fastBackward(){baseTime=me.time;startTime=Date.now();_state=Timer.PLAYING;_speed=_reset.speed*-2;setTimerInterval();dispatchEvent(new TimerEvent("play",{time:baseTime}))}fastBackward.parent=me;me.fastBackward=fastBackward;function addMarker(time,callback){var marker=time;if(!(marker instanceof TimerMarker)){marker=new TimerMarker(time,callback)}markers.push(marker);return markers.length-1}me.addMarker=addMarker;function removeMarker(marker){markers[marker]=null}me.removeMarker=removeMarker;function setTimerInterval(){if(interval==null&&_withEvents){interval=context.setInterval(update,Timer.PRECISION)}}function clearTimerInterval(){if(interval!==null){context.clearInterval(interval)}interval=null}function update(){var time=me.time;dispatchEvent(new TimerEvent("update",{time:time}));var caphit=testCaps(time);testTick(time,caphit);testMarkers(time,caphit);prevTime=time}update.parent=me;var lastTick=0;function testCaps(workTime){var caphit=false;var ostate=_state;if(workTime>=_top){caphit=true;dispatchEvent(new TimerEvent("top",{time:_top}));if(_loop&&ostate){baseTime=_bottom+(workTime-_top);startTime=Date.now();dispatchEvent(new TimerEvent("bottom",{time:_bottom}))}else{if(ostate){workTime=_top;baseTime=_top;startTime=Date.now();_state=Timer.STOPPED;clearTimerInterval();dispatchEvent(new TimerEvent("stop",{time:_top}))}}}if(workTime<=_bottom&&!caphit){caphit=true;dispatchEvent(new TimerEvent("bottom",{time:_bottom}));if(_loop&&ostate){baseTime=_top-(_bottom-workTime);startTime=Date.now();dispatchEvent(new TimerEvent("top",{time:_top}))}else{if(ostate){workTime=_bottom;baseTime=_bottom;startTime=Date.now();_state=Timer.STOPPED;clearTimerInterval();dispatchEvent(new TimerEvent("stop",{time:_bottom}))}}}return caphit}testTick.parent=me;function testTick(workTime){var prevTickTime=prevTime%_interval;var tickTime=me.time%_interval;if(_speed>0&&_state>0){if(tickTime<prevTickTime){var returnTime=workTime-(workTime%_interval);dispatchEvent(new TimerEvent("tick",{time:returnTime}))}}else{if(_speed<0&&_state>0){if(tickTime>prevTickTime){var returnTime=workTime+(workTime%_interval);dispatchEvent(new TimerEvent("tick",{time:returnTime}))}}}}testTick.parent=me;function testMarkers(workTime,fireOnce){for(var i=0;i<markers.length;i++){var marker=markers[i];if(_speed>0&&(_state>0||fireOnce)&&marker){if(((prevTime<marker.time)&&(workTime>marker.time))||(workTime==marker.time)){var event=new TimerEvent("marker",marker);if(marker.callback){marker.callback(event)}dispatchEvent(event)}}else{if(_speed<0&&(_state>0||fireOnce)&&marker){if(((prevTime>marker.time)&&(workTime<marker.time))||(workTime==marker.time)){var event=new TimerEvent("marker",marker);if(marker.callback){marker.callback(event)}dispatchEvent(event)}}}}}testMarkers.parent=me;var listeners={bottom:[],marker:[],play:[],reset:[],stop:[],tick:[],top:[],update:[]};function addEventListener(type,listener,options){if(!(type in listeners)){listeners[type]=[]}listeners[type].push(listener)}me.addEventListener=addEventListener;function removeEventListener(type,listener,options){if(!(type in listeners)){return}var stack=listeners[type];for(var i=0;i<stack.length;i++){if(stack[i]===listener){stack.splice(i,1);return}}}me.removeEventListener=removeEventListener;function dispatchEvent(event){if(!(event.type in listeners)){return true}var stack=listeners[event.type];event.target=me;if(stack.on){stack.on.call(me,event)}for(var i=0;i<stack.length;i++){stack[i].call(me,event)}return !event.defaultPrevented}me.dispatchEvent=dispatchEvent;Object.defineProperty(me,"onbottom",{get:function(){return listeners.bottom.on},set:function(value){listeners.bottom.on=value},enumerable:true});Object.defineProperty(me,"onmarker",{get:function(){return listeners.marker.on},set:function(value){listeners.marker.on=value},enumerable:true});Object.defineProperty(me,"onplay",{get:function(){return listeners.play.on},set:function(value){listeners.play.on=value},enumerable:true});Object.defineProperty(me,"onreset",{get:function(){return listeners.reset.on},set:function(value){listeners.reset.on=value},enumerable:true});Object.defineProperty(me,"onstop",{get:function(){return listeners.stop.on},set:function(value){listeners.stop.on=value},enumerable:true});Object.defineProperty(me,"ontick",{get:function(){return listeners.tick.on},set:function(value){listeners.tick.on=value},enumerable:true});Object.defineProperty(me,"ontop",{get:function(){return listeners.top.on},set:function(value){listeners.top.on=value},enumerable:true});Object.defineProperty(me,"onupdate",{get:function(){return listeners.update.on},set:function(value){listeners.update.on=value},enumerable:true});construct.apply(me,arguments)}context.Timer=Timer;Object.defineProperty(Timer,"PRECISION",{value:1,enumerable:true});Object.defineProperty(Timer,"STOPPED",{value:0,enumerable:true});Object.defineProperty(Timer,"PLAYING",{value:1,enumerable:true});Object.defineProperty(Timer,"DEFAULT_TIME",{value:0,enumerable:true});Object.defineProperty(Timer,"DEFAULT_INTERVAL",{value:1000,enumerable:true});Object.defineProperty(Timer,"DEFAULT_PLAYSTATE",{value:Timer.STOPPED,enumerable:true});Object.defineProperty(Timer,"DEFAULT_SPEED",{value:1,enumerable:true});Object.defineProperty(Timer,"DEFAULT_BOTTOM",{value:Number.NEGATIVE_INFINITY,enumerable:true});Object.defineProperty(Timer,"DEFAULT_TOP",{value:Number.POSITIVE_INFINITY,enumerable:true});Object.defineProperty(Timer,"DEFAULT_LOOP",{value:false,enumerable:true});Object.defineProperty(Timer,"DEFAULT_RAISES_EVENTS",{value:true,enumerable:true});function TimerEvent(typeArg,eventInit){const me=this;if(Event){me.__proto__.__proto__=new Event(typeArg)}var target=eventInit instanceof Timer?eventInit:TimerEvent.caller?TimerEvent.caller.parent:{time:0};var trusted=target instanceof Timer;var time=(typeof arguments[2]==="number")?arguments[2]:(eventInit.time?eventInit.time:target.time);var marker=eventInit instanceof TimerMarker?eventInit:undefined;Object.defineProperty(me,"bubbles",{value:false,enumerable:true});Object.defineProperty(me,"cancelBubble",{value:false,enumerable:true,writable:true});Object.defineProperty(me,"cancelable",{value:false,enumerable:true});Object.defineProperty(me,"composed",{value:false,enumerable:true});Object.defineProperty(me,"currentTarget",{value:target,enumerable:true});Object.defineProperty(me,"defaultPrevented",{value:false,enumerable:true});Object.defineProperty(me,"eventPhase",{value:0,enumerable:true});Object.defineProperty(me,"isTrusted",{value:trusted,enumerable:true});Object.defineProperty(me,"path",{value:[],enumerable:true});Object.defineProperty(me,"returnValue",{value:true,enumerable:true});Object.defineProperty(me,"srcElement",{value:target,enumerable:true});Object.defineProperty(me,"target",{value:target,enumerable:true});Object.defineProperty(me,"time",{value:time,enumerable:true});Object.defineProperty(me,"timeStamp",{value:Date.now(),enumerable:true});Object.defineProperty(me,"type",{value:typeArg,enumerable:true});if(eventInit instanceof TimerMarker){Object.defineProperty(me,"marker",{value:marker,enumerable:true})}else{var _undefined;Object.defineProperty(me,"marker",{value:_undefined,enumerable:true})}}context.TimerEvent=TimerEvent;function TimerMarker(time,callback){const me=this;var _time=time;var _callback=callback;Object.defineProperty(me,"time",{get:function(){return _time},enumerable:true});Object.defineProperty(me,"callback",{get:function(){return _callback},enumerable:true})}context.TimerMarker=TimerMarker;(function(){if(typeof Math.toZero==="undefined"){Math.toZero=toZero}else{console.error("Math.toZero is already defined.")}function toZero(number){if(number<0){return Math.ceil(number)}else{return Math.floor(number)}}}())}(this));
